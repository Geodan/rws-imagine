<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/underscore/underscore.js"></script>
<script src="../libs/cow.js"></script>
<dom-module id="imagine-instance">
<template>
</template>
</dom-module>
<script>
Polymer({
		is: 'imagine-instance',
		properties:{
			kaartjes: {
				type:Array,
				value: function(){
					return [];
				},
				notify: true
			},
			verbindingen: {
				type: Array,
				value: function(){
					return [];
				},
				notify: true
			},
			verbindingen_org: {
				type: Array,
				value: function(){
					return [];
				},
				notify: true
			},
			team: String,
			scenario:  String,
			time: {
				type: Number,
				value: new Date().getTime(),
				observer: '_calculateScore'
			},
			score: {
				type: Number,
				notify: true
			},
			reset: Boolean
		},
		observers: [
			'_projectChange(team, scenario)'
		],
		_generateEvents: function(){
			//FIXME: to be replace with a real events list instead of a random one
			function random(){
				return Math.random()*100;
			}
			for (var i = 0; i < 40; i++){
				var id = new Date().getTime().toString();
				var item = this._project.items({_id: id+i});
				var x = random();
				var y = random();
				
				item.data({
					id: i,
					type: 'kaartje',
					name: 'Lorem ipsum',
					active_org: y<50?false:true,
					x_org: x,
					y_org: y,
					x: null,
					y: null,
					active: false
				}).sync();
			}
			
		},
		_generateLinks: function(){
			function random(){
				return Math.round(Math.random()*(active.length-1));
			}
			var active = this.kaartjes.filter(function(d){return d.data('y') > 50;});
			for (var i = 0;i<active.length;i++){
				var eventA = active[random()];
				var eventB = active[random()];
				if(eventA != eventB){
					var id = new Date().getTime().toString();
					var item = this._project.items({_id: id+i});
					item.data({
						id:'vo'+i,
						type: 'verbinding_org',
						van: eventA.id(),
						naar:eventB.id()
					}).sync();
				}
			}
		},
		/*
		createProject() - Create a new project based on the already given team and scenario
		*/
		createProject: function(){
			if (this.team && this.scenario){
				var newproject = this._core.projects({});
				this._core.project(newproject.id());//set as current project
				newproject.data({team:this.team,scenario:this.scenario}).sync();
				this._project = newproject;
				this._generateEvents();
			}
			else {
				console.warn('No team or scenario specified');
			}
		},
		/*
		deleteProject() - Set the project to deleted
		*/
		deleteProject: function(){
			if (this._project){
				this._project.deleted(true).sync();
			}
			else {
				console.warn('No project to delete');
			}
		},
		/*
		createLink() - Create a new link item between to events 
		*/
		createLink: function(fromid, toid){
			var item = this._project.items({});
			item.data('type','verbinding').data('vanid',fromid).data('naarid',toid).sync();
		},
		/*
		deleteLink() - Set a certain link deleted
		*/
		deleteLink: function(fromid, toid){
			this.verbindingen.filter(function(d){
				return d.data('vanid') == fromid && d.data('naarid') == toid;
			}).forEach(function(d){
				d.deleted(true).sync();
			});
			
		},
		/*
		_reset() - Set all verbindingen to deleted and coordinates of kaartjes to null
		*/
		_reset: function(){
			var self = this;
			
				this._project.items().filter(function(d){
					return !d.deleted() && d.data('type')=='verbinding';
				}).forEach(function(d){
					d.deleted(true);
				});
				this._project.items().filter(function(d){
					return !d.deleted() && d.data('type')=='kaartje';
				}).forEach(function(d){
					d.data('x','').data('y','');
				});
				this._project.itemStore().sync();
			
		},
		_projectChange: function(){
			var self = this;
			if (!this._core){
				console.warn('No COW core ready');
				return;
			}
			else if (this.team && this.scenario){
				var projects = this._core.projects().filter(function(d){
					return !d.deleted() && d.data('team') == self.team && d.data('scenario') == self.scenario;
				});
				if (projects.length > 1){
					console.warn('More than one project having team ' + this.team + ' and scenario ' + this.scenario);
					return;
				}
				else if (projects.length < 1){
					console.warn('No project having team ' + this.team + ' and scenario ' + this.scenario);
					return;
				}
				else {
					this._project = projects[0];
					this._project.itemStore().on('synced',function(){
						if (self.reset){
							self._reset();
							self.reset = false;
						}
					});
					this._project.itemStore().on('datachange',function(){
						self._calculateScore();
						self.kaartjes = self._project.items().filter(function(d){
							return !d.deleted() && d.data('type')=='kaartje';
						});
						self.kaartjes.forEach(function(d,i){
							self.set('kaartjes.'+i+'._data.x',d.data('x'));
							self.set('kaartjes.'+i+'._data.y',d.data('y'));
						});
						self.verbindingen_org = self._project.items().filter(function(d){
							return !d.deleted() && d.data('type')=='verbinding_org';
						});
						
					
						self.verbindingen = self._project.items().filter(function(d){
							return !d.deleted() && d.data('type')=='verbinding';
						});
						self.verbindingen.forEach(function(d,i){
							self.set('verbindingen.'+i+'._data.vanid',d.data('vanid'));
							self.set('verbindingen.'+i+'._data.naarid',d.data('naarid'));
						});
						
					});
				}
			}
			else {
				console.warn('No team or scenario set');
			}
			
			
		},
		_calculateScore: function(){
			var self = this;
			var time = this.time;
			if (this._project){
				var score = 0;
				var eventfactor = function(d){
					return 5 - (100-d.data('y_org'))/10;
				};
				var deltax = function(d){
					if (d.data('y_org') > 50 && d.data('x') > 0 && d.data('x_org') > 0){
						return 5 - Math.abs((d.data('x')-d.data('x_org'))/20);
					}
					return 0;
				};
				var deltay = function(d){
					//only calculate when an x value is present
					if (d.data('x') > 0 && d.data('x_org') > 0){
						var delta = Math.abs(d.data('y_org') - d.data('y'));
						if (5 - delta/10> 0){ //meaning it is scoring positive
							return 5 - delta/10;
						}
						else {
							return eventfactor(d) - delta/20; 
						}
					}
					return 0;
				};
				var deltafactor = 2;
				var deltacutoff = 40;
				var linkfactor = 1;
				var items = this._project.items().filter(function(d){
					return !d.deleted() && d.data('type')=='kaartje';
				});
				items.forEach(function(d,i){
					var itemscore = 0;
					//if (d.data(time) && d.data(time).y >=50){
					if (d.data('y') >=50){
						itemscore = itemscore + eventfactor(d);
			
						//var dx = d.data('x_org') - d.data(time).x;
						//score = score + Math.exp(-Math.PI * Math.pow(dx/deltacutoff,2)) * deltafactor;
						itemscore = itemscore + deltax(d);
						
						//var dy = d.data('y_org') - d.data(time).y;
						//score = score + Math.exp(-Math.PI * Math.pow(dy/deltacutoff,2)) * deltafactor;
						itemscore = itemscore + deltay(d);
						
						itemscore = Math.round(itemscore);
						score = score + itemscore;
						d.data('score',itemscore);
						self.set('kaartjes.'+i+'._data.score',itemscore);
					}
				});
				var items = this._project.items().filter(function(d){
					return !d.deleted() && d.data('type')=='verbinding';
				});
				items.forEach(function(d,i){
					
				});
				
				this.score = Math.round(score);
			}
			else {
				console.warn('No project selected');
			}
		},
		
		ready: function(){
			var self = this;
			var core = new Cow.core({
				herdname: 'imagine',
				maxage: 1000 * 60 * 60 * 24 * 30 //30 days
			});
			window.core = core; //for debug
			this._core = core;
			core.projectStore().loaded.then(function(){
				  console.log('projectstore loaded');
				  
			});
			core.projectStore().on('synced', function(){
				console.log('projectstore synced');
				self._projectChange(); //start selection of project
			});
			
			//add a default socketserver
			if (!core.socketserver('default')){
			  core.socketservers({
				_id: 'default', 
				data: {protocol:'wss',ip:'websocket.geodan.nl', port:443, dir: 'imagine'}
			  });
			};
			core.socketserver('default');
			core.connect();
		}
});
</script>
 